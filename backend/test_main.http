### 登录（JSON）
POST http://127.0.0.1:8000/api/v1/auth/login
Content-Type: application/json
Accept: application/json

{
  "username": "teacher1",
  "password": "teacher123"
}

> {%
// 保存 access_token
const data = JSON.parse(response.body);
if (data && data.access_token) {
  client.global.set("access_token", data.access_token);
  client.log("Saved access_token");
} else {
  throw new Error("No access_token in response. Check credentials.");
}
%}

###

### 获取当前用户
GET http://127.0.0.1:8000/api/v1/auth/me
Accept: application/json
Authorization: Bearer {{access_token}}

###

### 健康检查
GET http://127.0.0.1:8000/api/v1/health
Accept: application/json

###

### 版本信息
GET http://127.0.0.1:8000/api/v1/version
Accept: application/json


################################################################
# ↓↓↓ Shops 模块接口测试（保留且优化：不删除主店铺）↓↓↓
################################################################

### 创建店铺（主店铺，后续 listings 将复用）
POST http://127.0.0.1:8000/api/v1/shops
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "name": "Teacher Main Shop",
  "initial_balance": 1000.50
}

> {%
// 保存主店铺ID
try {
  const data = JSON.parse(response.body);
  if (data && data.id) {
    client.global.set("shop_id", String(data.id));
    client.log("Saved shop_id = " + data.id);
  }
} catch(e) {
  client.log("Create shop response not JSON or error: " + e.message);
}
%}

###

### 我的所有店铺（兜底确保拿到一个 shop_id）
GET http://127.0.0.1:8000/api/v1/shops/mine
Authorization: Bearer {{access_token}}
Accept: application/json

> {%
// 若上一请求未保存，则这里确保设置 shop_id
const list = JSON.parse(response.body);
if (Array.isArray(list) && list.length > 0) {
  if (!client.global.get("shop_id") && list[0].id) {
    client.global.set("shop_id", String(list[0].id));
    client.log("Ensured shop_id = " + list[0].id);
  }
} else {
  throw new Error("当前用户没有店铺。请先创建店铺再继续。");
}
%}

###

### 按 ID 查看店铺（需要店主或 admin）
GET http://127.0.0.1:8000/api/v1/shops/{{shop_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 更新店铺名称（PATCH）
PATCH http://127.0.0.1:8000/api/v1/shops/{{shop_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "name": "Teacher Main Shop - Renamed"
}

###

### 验证更新后的店铺（GET by id）
GET http://127.0.0.1:8000/api/v1/shops/{{shop_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 更新店铺状态为 closed（PATCH）
PATCH http://127.0.0.1:8000/api/v1/shops/{{shop_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "status": "closed"
}

###

### 按状态筛选我的店铺（仅 closed）
GET http://127.0.0.1:8000/api/v1/shops/mine?status=closed
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 将店铺状态改回 active（为后续 listings 使用）
PATCH http://127.0.0.1:8000/api/v1/shops/{{shop_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "status": "active"
}


################################################################
# ↓↓↓ Products 模块（全局商品库；按你给的结构：product_code/name/base_cost）↓↓↓
################################################################

### 创建商品（全局商品库）
POST http://127.0.0.1:8000/api/v1/products
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "product_code": "PCODE-001",
  "name": "Global Product A",
  "category": "CategoryA",
  "base_cost": 88.80
}

> {%
// 保存 product_id
try {
  const data = JSON.parse(response.body);
  if (data && data.id) {
    client.global.set("product_id", String(data.id));
    client.log("Saved product_id = " + data.id);
  }
} catch(e) {
  client.log("Create product response not JSON: " + e.message);
}
%}

###

### 列出商品（支持 q / category / 分页）
GET http://127.0.0.1:8000/api/v1/products?q=PCODE-001&page=1&page_size=10
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 按 ID 获取商品
GET http://127.0.0.1:8000/api/v1/products/{{product_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 更新商品（PATCH）
PATCH http://127.0.0.1:8000/api/v1/products/{{product_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "name": "Global Product A (Updated)",
  "base_cost": 90.00
}

###

### 再查一次（验证更新）
GET http://127.0.0.1:8000/api/v1/products/{{product_id}}
Authorization: Bearer {{access_token}}
Accept: application/json


################################################################
# ↓↓↓ Listings 模块（店铺上架：关联 shop_id + product_id）↓↓↓
################################################################

### 创建上架（listing）：把全局商品挂到我的店铺
POST http://127.0.0.1:8000/api/v1/listings
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "shop_id": {{shop_id}},
  "product_id": {{product_id}},
  "price": 199.99,
  "marketing_budget": 50.00,
  "status": "active"
}

> {%
// 保存 listing_id
try {
  const data = JSON.parse(response.body);
  if (data && data.id) {
    client.global.set("listing_id", String(data.id));
    client.log("Saved listing_id = " + data.id);
  }
} catch(e) {
  client.log("Create listing response not JSON: " + e.message);
}
%}

###

### 列出我的上架（可选：?shop_id={{shop_id}}&product_id={{product_id}}）
GET http://127.0.0.1:8000/api/v1/listings?shop_id={{shop_id}}&page=1&page_size=20
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 按 ID 获取 listing
GET http://127.0.0.1:8000/api/v1/listings/{{listing_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 更新 listing（价格/预算/状态）
PATCH http://127.0.0.1:8000/api/v1/listings/{{listing_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "price": 189.90,
  "marketing_budget": 60.00,
  "status": "inactive"
}

###

### 再查一次 listing（验证更新）
GET http://127.0.0.1:8000/api/v1/listings/{{listing_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 删除 listing（DELETE）
DELETE http://127.0.0.1:8000/api/v1/listings/{{listing_id}}
Authorization: Bearer {{access_token}}

###

### 再次获取 listing（应返回 404）
GET http://127.0.0.1:8000/api/v1/listings/{{listing_id}}
Authorization: Bearer {{access_token}}
Accept: application/json


################################################################
# ↓↓↓ 清理演示：删除“临时店铺”和“商品”等（可选）↓↓↓
################################################################

### （可选）创建一个临时店铺，并立即删除，避免影响主店铺
POST http://127.0.0.1:8000/api/v1/shops
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "name": "Temp Shop To Delete",
  "initial_balance": 10
}

> {%
// 保存临时店铺ID
try {
  const data = JSON.parse(response.body);
  if (data && data.id) {
    client.global.set("temp_shop_id", String(data.id));
    client.log("Saved temp_shop_id = " + data.id);
  }
} catch(e) {
  client.log("Create temp shop response not JSON: " + e.message);
}
%}

###

### 删除临时店铺（DELETE，幂等）
DELETE http://127.0.0.1:8000/api/v1/shops/{{temp_shop_id}}
Authorization: Bearer {{access_token}}

###

### 删除商品（确保已无 listing 引用后再删）
DELETE http://127.0.0.1:8000/api/v1/products/{{product_id}}
Authorization: Bearer {{access_token}}

###

### 再次获取商品（应返回 404）
GET http://127.0.0.1:8000/api/v1/products/{{product_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

### 获取所有商品（不分页，用于管理或调试）
GET http://127.0.0.1:8000/api/v1/products
Authorization: Bearer {{access_token}}
Accept: application/json


################################################################
# ↓↓↓ Inventory 模块（库存）↓↓↓
################################################################

### 设置库存为 100（PUT：不存在则创建）
PUT http://127.0.0.1:8000/api/v1/inventory/{{shop_id}}/{{product_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "on_hand_qty": 100
}

###

### 查询库存（GET）
GET http://127.0.0.1:8000/api/v1/inventory/{{shop_id}}/{{product_id}}
Authorization: Bearer {{access_token}}
Accept: application/json

###

### 增加库存 25（PATCH）
PATCH http://127.0.0.1:8000/api/v1/inventory/{{shop_id}}/{{product_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "delta": 25
}

###

### 减少库存 60（PATCH）
PATCH http://127.0.0.1:8000/api/v1/inventory/{{shop_id}}/{{product_id}}
Authorization: Bearer {{access_token}}
Content-Type: application/json
Accept: application/json

{
  "delta": -60
}

###

### 删除库存记录（DELETE）
DELETE http://127.0.0.1:8000/api/v1/inventory/{{shop_id}}/{{product_id}}
Authorization: Bearer {{access_token}}
